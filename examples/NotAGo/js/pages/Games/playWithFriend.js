var namePlayer,infoPlayerFB,urlImgPlayerFB,infoTeamConnected;function PlayWithFriend(e){var o=this;Konva.Layer.call(o),e=void 0!==e?e:{};var n=GameController.getInfoPlayerFB(infoPlayerFB.id),r={Fb_id:"player02",name:"Van Su Phan",score:0,image:"images/game/avatar.jpg",winAmount:0},t=[];t.push(n,r);var l=t[0].score,a=t[1].score,c=io.connect(urlAPI);c.on("send-all-id-client",e=>{arrUserLocal=[...e],c.emit("send-info-fb-client",{id_socket:c.id,infoPlayerFB:infoPlayerFB})}),c.on("SEND-DISCONNECT-TO-CLIENT",function(e){e.id_socket,c.id}),$(GameController).on(GameController.Events.LOGIN,function(){c=io.connect(urlAPI)}),$(GameController).on(GameController.Events.BACK_TO_MENU,function(){if(o.children[8]){if(2!=o.children[8].getAttr("routeLayer"))return;c.emit("BACK-MENU",s),console.log(" ROUTE 2222222"),C.stop(),u.clearBoard(),v(u)}}),c.on("BACK-MENU-TO-CLIENT",function(e){o.children[8]&&(C.stop(),u.clearBoard(),v(u),console.log("BACK MENU 2"),o.children[8].destroy(),changeSceneById(0),changeSceneById(2),G())}),$(GameController).on(GameController.Events.LOGOUT,function(){c.disconnect()}),$(GameController).on(GameController.Events.REPLAY,function(){if(o.children[8]){if(2!=o.children[8].getAttr("routeLayer"))return;u.clearBoard(),v(u),o.children[8].destroy(),popupWait=new PopupWait({statusResult:statusResult,routeLayer:2,urlImage:s.image||urlImgPlayerFB}),o.add(popupWait),popupWait.draw(),c.emit("REPLAY",s)}}),c.on("REPLAY-TO-CLIENT",function(e){console.log("REPLAY ALL"),u.clearBoard(),o.children[8]&&o.children[8].destroy(),R(),c.emit("REPLAY-AGAIN-TO-SERVER",e)}),c.on("REPLAY-AGAIN-TO-CLIENT",function(e){u.clearBoard(),v(u),o.children[8]&&o.children[8].destroy(),changeSceneById(0),changeSceneById(2)}),$(GameController).on(GameController.Events.REPLAY_2,function(){console.log("REPLAY-TO-CLIENT-2"),u.clearBoard(),v(u),o.children[8]&&o.children[8].destroy(),C.stop(),changeSceneById(0),changeSceneById(2),c.emit("REPLAY-2",s)}),c.on("REPLAY-TO-CLIENT-2",function(e){u.clearBoard(),v(u),o.children[8]&&o.children[8].destroy(),C.stop(),changeSceneById(0),changeSceneById(2)}),$(GameController).on(GameController.Events.CANCEL,function(){c.emit("CANCEL",s)}),c.on("CANCEL-TO-CLIENT",function(e){console.log("CANCEL-TO-CLIENT"),u.clearBoard(),o.children[8]&&(o.children[8].destroy(),changeSceneById(0),changeSceneById(2)),G()});var i={name:null,value:null,team:null,infoPlayer:{},image:n.image},s={id:null,Fb_id:null,name:null,team:null,score:0,image:n.image,winAmount:0,room:null};c.on("SEND_ROOM",e=>{console.log(e,"SEND_ROOM"),i.name=e.name,i.value=e.value,s.id=c.id,s.name=namePlayer,s.Fb_id=infoPlayerFB.id,s.room=i.name,s.winAmount=GameController.getInfoPlayerFB(infoPlayerFB.id).winAmount;var o=e.value,n=[];if(2===o.length){for(var r in o.sockets)o.sockets.hasOwnProperty(r)&&n.push(r);s.team=n.indexOf(c.id),i.team=n.indexOf(c.id),c.emit("TEAM-CONNECTED",s),c.on("SEND-TEAM-2-JOIN-TO-CLIENT",e=>{!function(e){new Konva.Tween({duration:1.5,node:e,opacity:0,onFinish:function(){A.hide()}}).play()}(A),w=s.team,u.clearBoard(),O(u,w)})}else L(u),A.show()});var d=new Logo;o.add(d);var u=new Board({x:sw/2-150,y:188}),h=new InfoPlayerCard({scoreX:30,scoreY:9,score:l,image:n.image}),m=new InfoPlayerCard({scoreX:30,scoreY:9,score:a,image:r.image}),f=new Konva.Group({x:sw/2-50-100,y:136}),p=new Konva.Group({x:sw/2-50+100,y:136}),g=new Konva.Group({x:sw/2-89.5,y:498}),E=new Konva.Group({x:sw/2-27,y:124}),C=new TimeLine({}),y=new ButtonQuitGame({text:"QUIT GAME"}),A=new PopupTeam2({text:"Please waiting...",x:sw/2-150,y:188});new PopupTeam2({text:"YOUR TEAM BLUE  ",x:sw/2-150,y:188}),new PopupTeam2({text:"YOUR TEAM WHITE",x:sw/2-150,y:188,fill:COLOR_WHITE});C.on(C.Events.ON_COMPLETE,N),C.on(C.Events.ON_PLAY,function(){C.getTime()}),E.add(C),g.add(y),p.add(m),f.add(h);var w,B=new Copyright;function T(e){w=0,I(e)}function P(e){w=1,I(e)}function I(e){e.show(),e.changeColor(GameController.getColorTeam(w)),e.draw()}function O(e,n){var r=e.children[0].children;if(0===n)for(let t=0;t<r.length;t++)r[t].children[0].on("click mousedown touchstart",function(){var l=F(r[t]),a={team:n,coord:l,roomClient:i};c.emit("TEAM_0_CLICK",a);colorBox=GameController.getColorTeam(n),r[t].children[0].setAttrs({status:"on",colorBox:colorBox}),r[t].children[1].setAttrs({status:"on",colorBox:colorBox}),T(r[t].children[1]),r[t].children[1].children[0].setAttrs({status:"on",colorBox:colorBox}),r[t].children[2].show(),GameController.animScale(r[t].children[1].children[0]),r[t].children[1].children[0].draw(),r[t].children[0].draw(),L(e),GameController.gameProcessing(r[t],r[t].parent.children),C.start(),o.batchDraw(),r[t].draw()});if(1===n)for(let t=0;t<r.length;t++)r[t].children[0].on("click mousedown touchstart",function(){var l=F(r[t]),a={team:n,coord:l,roomClient:i};c.emit("TEAM_01_CLICK",a);colorBox=GameController.getColorTeam(n),r[t].children[0].setAttrs({status:"on",colorBox:colorBox}),r[t].children[1].setAttrs({status:"on",colorBox:colorBox}),P(r[t].children[1]),r[t].children[1].children[0].setAttrs({status:"on",colorBox:colorBox}),r[t].children[2].show(),GameController.animScale(r[t].children[1].children[0]),r[t].children[1].children[0].draw(),r[t].children[0].draw(),L(e),GameController.gameProcessing(r[t],r[t].parent.children),C.start(),o.batchDraw(),r[t].draw()})}function L(e){console.log("OFF !!!!!");var o=e.children[0].children;for(let e=0;e<o.length;e++)o[e].children[0].off()}function N(){var e=t.findIndex(e=>e.Fb_id===infoPlayerFB.id),o=Math.abs(e-1);t[e].score<t[o].score&&(statusResult=0,t[e].winAmount-=1,_(urlAPI+"setpoint",t[e]),C.stop()),t[e].score>t[o].score&&(statusResult=1,t[e].winAmount+=1,_(urlAPI+"setpoint",t[e]),C.stop()),t[e].score==t[o].score&&(statusResult=-1,C.stop()),C.stop(),S(),x(),console.log("SHOW POPUP HET GIO")}function x(){null!=statusResult&&(popupholder=new Popup({statusResult:statusResult,routeLayer:2,urlImage:s.image||urlImgPlayerFB}),o.add(popupholder))}function R(){null!=statusResult&&(popupReplay=new PopupReplay({statusResult:statusResult,routeLayer:2,urlImage:urlImgPlayerFB||s.image}),o.add(popupReplay),popupReplay.draw())}function G(e){popupFriendOut=new PopupFriendOut({statusResult:statusResult||1,routeLayer:2,urlImage:infoTeamConnected.image},e),console.log("OUT FRIEND"),o.add(popupFriendOut),popupFriendOut.draw()}function v(e){arrBox=e.children[0].children;for(var o=0,n=0,r=arrBox.filter(e=>"on"===e.children[1].children[0].attrs.status).length,c=0;c<arrBox.length;c++)"#165470"===arrBox[c].children[1].children[0].attrs.fill&&"on"===arrBox[c].children[1].children[0].attrs.status&&(o+=1),"#ffffff"===arrBox[c].children[1].children[0].attrs.fill&&"on"===arrBox[c].children[1].children[0].attrs.status&&(n+=1);if(l=o,a=n,t[0].score=l,t[1].score=a,m.children[1].children[1].setAttrs({text:a.toString()||0}),h.children[1].children[1].setAttrs({text:l.toString()||0}),h.children[2].draw(),m.children[2].draw(),r===arrBox.length){var i=t.findIndex(e=>e.Fb_id===infoPlayerFB.id),s=Math.abs(i-1);t[i].score>t[s].score?(statusResult=1,t[i].winAmount+=1,_(urlAPI+"setpoint",t[i]),GameController.setScorePlayer(t[0].name,0)):(statusResult=0,t[i].winAmount-=1,_(urlAPI+"setpoint",t[i]),GameController.setScorePlayer(t[1].name,0)),C.stop(),S(),x()}}function S(){u.lock()}function F(e){return e.coord}function M(e,o,n=0){color=GameController.getColorTeam(o),0===o?(T(e[n].children[1]),e[n].setAttrs({status:"on",colorBox:color}),e[n].children[0].setAttrs({status:"on",colorBox:color}),e[n].children[1].setAttrs({status:"on",colorBox:color}),e[n].children[1].children[0].setAttrs({status:"on",colorBox:color}),e[n].children[1].show(),e[n].children[2].show(),e[n].children[1].draw(),e[n].children[2].draw(),e[n].children[1].children[0].draw(),GameController.gameProcessing(e[n],u.children[0].children)):(P(e[n].children[1]),e[n].setAttrs({status:"on",colorBox:color}),e[n].children[0].setAttrs({status:"on",colorBox:color}),e[n].children[1].setAttrs({status:"on",colorBox:color}),e[n].children[1].children[0].setAttrs({status:"on",colorBox:color}),e[n].children[1].show(),e[n].children[2].show(),e[n].children[1].draw(),e[n].children[2].draw(),e[n].children[1].children[0].draw(),GameController.gameProcessing(e[n],u.children[0].children))}function D(e,o,n){return e.filter(function(e){return e.coord[0]==n&&e.coord[1]==o})}function _(e=urlAPI+"setpoint",o){$.ajax({url:e,type:"POST",dataType:"json",data:o,contentType:"application/x-www-form-urlencoded; charset=UTF-8",success:function(e){console.log("Post completed !")},error:function(e){console.log(e," ERROR ")}})}o.add(f,p,E,u,g,B,A),f.draw(),A.hide(),g.on("click mousedown touchstart",function(){console.log("BACK MENU"),c.emit("QUIT-GAME",s),c.disconnect(),Master.init()}),c.on("QUIT-GAME-TO-CLIENT",function(e){console.log("QUIT-GAME-TO-CLIENT 2222222222"),!1!==o.getAttr("visible")&&(N(),o.children[8].destroy(),G(function(){o.children[8].children[1].draw()}))}),o.awake=function(){console.log(s.team),1===s.team&&(i.infoPlayer=s,c.emit("TEAM-2-JOIN",i))},c.on(),c.on("SEND-TO-PLAYER-1",e=>{var o=e.coord;M(D(u.children[0].children,o[1],o[0]),e.team),O(u,1)}),c.on("SEND-TO-PLAYER-0",e=>{var o=e.coord;M(D(u.children[0].children,o[1],o[0]),e.team),O(u,0)}),c.on("SEND-TO-ALL-PLAYER",e=>{var n=e.coord,r=D(u.children[0].children,n[1],n[0]);GameController.animScale(r[0].children[1].children[0]),C.start(),v(u),o.batchDraw()}),c.on("SERVER-SEND-TO-TEAM-CONNECTED",function(e){infoTeamConnected=e,0===e.team&&(t[0]=e,h.children[3].getAttrs().image.src=e.image),1===e.team&&(t[1]=e,m.children[3].getAttrs().image.src=e.image)}),c.on("DISCONNECT-SEND-TO-CLIENT",function(){console.log("DISCONNECT-SEND-TO-CLIENT")})}$(GameController).on(GameController.Events.LOGIN,function(e){infoPlayerFB=e.playerInfo,namePlayer=e.playerInfo.name,urlImgPlayerFB=e.playerInfo.picture.data.url}),PlayWithFriend.prototype=Object.assign(Object.create(Konva.Layer.prototype),{});